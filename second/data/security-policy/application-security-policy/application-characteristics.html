<!--安全策略-应用安全策略-特征库-->
<div class="portlet" >
    <div class="portlet-title">
        <div class="caption">
            <form class="form-inline">
                <div class="form-group">
                    <label>查询关键字：</label>
                    <input  id="typeTreeSearch1">
                </div>
                <div class="form-group">
                    <label>类型：</label>
                    <select id="selectType1">
                        <option value="">请选择</option>
                        <option value="1">Web_Server_Bug</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>级别：</label>
                    <select id="selectLevel1">
                        <option value="">请选择</option>
                        <option value="1">轻微</option>
                        <option value="2">低</option>
                        <option value="3">中</option>
                        <option value="4">高</option>
                    </select>
                </div>
                <button type="button" class="f-btn-blue"><img src="imgs/41.png"/>查找</button>
            </form>
        </div>
    </div>
    <div class="portlet-body portlet-body-chara">
        <div class="row">
            <div class="col-xs-3">
                <div class="portlet bordered" >
                    <div class="portlet-title">基本特征库</div>
                    <div class="portlet-body">
                        <ul id="treeType1" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="col-xs-9">
                <div class="portlet-body">
                    <div class="pack">
                        <div class="row">
                            <div class="col-xs-6">
                                特征ID<span></span>
                            </div>
                            <div class="col-xs-6">
                                操作系统<span></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                特征名称<span></span>
                            </div>
                            <div class="col-xs-6">
                                WEB服务器<span></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                危害级别<span></span>
                            </div>
                            <div class="col-xs-6">
                                数据库<span></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                攻击类别<span></span>
                            </div>
                            <div class="col-xs-6">
                                编程语言<span></span>
                            </div>
                        </div>
                        <div class="row cur">
                            <div class="col-xs-12">
                                详细描述<span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-3">
                <div class="portlet bordered" >
                    <div class="portlet-title">
                        <span>自定义特征库</span>
                        <a href="javascript:;" class="curent"><img src="imgs/ad.png"/></a>
                        <a href="javascript:;"><img src="imgs/9.png"/></a>
                        <a href="javascript:;"><img src="imgs/4.png"/></a>
                    </div>
                    <div class="portlet-body">
                        <ul id="treeType3" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="col-xs-9">
                <div class="portlet-body custom">
                    <form>
                        <div class="row">
                            <div class="form-group col-xs-6">
                                <label>特征ID</label>
                                <input  disabled>
                            </div>
                            <div class="form-group col-xs-6">
                                <label>检测对象</label>
                                <input >
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group col-xs-6">
                                <label>特征名称</label>
                                <input >
                            </div>
                            <div class="form-group col-xs-6">
                                <label>匹配操作</label>
                                <input >
                            </div>
                        </div>
                        <div class="row curr">
                            <div class="form-group col-xs-6">
                                <label>危害级别</label>
                                <input  class="denger"><br/>
                                <label>攻击类别</label>
                                <input >
                            </div>
                            <div class="form-group col-xs-6">
                                <label>监测值</label>
                                <textarea></textarea>
                            </div>
                        </div>
                        <div class="form-group cur">
                            <label>详细描述</label>
                            <textarea></textarea>
                        </div>
                        <button type="button" class="btn add-btn">添加下一个</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <button type="button" class="f-btn-blue" disabled>保存</button>
</div>
<script>
    var selectSpan=$(".pack span"),//基本特征库细节显示框
            treeType1=$("#treeType1"),//基本特征库树
            selectButton1=$("#application-characteristics .form-inline button"),//基本特征库搜索按钮
            key1 = $("#typeTreeSearch1"),//基本特征库搜索框
            treeType3=$("#treeType3"),//自定义特征库树
    //自定义特征库显示框
            selectInput=$(".custom input"),
            selectTextarea=$(".custom textarea"),
            id = 1,//自定义特征库id的起始数字
            typeArr = [],//自定义类型记录数组
            idArr = [];//随机id记录数组
    position();//提示框位置

    $.fn.zTree.init(treeType1, setting, applicationSecurity);//加载基本特征库
    //基本特征库搜索框
    key1.bind("focus", focusKey)
            .bind("blur", blurKey)
            .bind("propertychange", searchNode)
            .bind("input", searchNode);
    selectButton1.bind("click", searchNodes);//搜索按钮
    //基本特征库树
    treeType1.delegate("ul li", "click", function () {
        var li = $(this);
        $.each(applicationSecurity, function (i, n) {
            (n.name === li.text() && n.ty === li.parent().siblings("a").text()) && addSpan(n, 2)
        });
    });
    //自定义特征库树
    treeType3.delegate("ul li", "click", function () {
        var li = $(this), i;
        $.each(applicationSecurityCustom, function (i, n) {
            (n.name === li.text() && n.ty === li.parent().siblings("a").text()) && addSpan(n, 4)
        });
        for (i = 0; i < 6; i++) {
            selectInput[i].setAttribute("disabled", "true");
            (i==0 || i==1) && selectTextarea[i].setAttribute("disabled", "true");
        }
        $("#application-characteristics .custom button").attr("disabled", true);
    });
    //自定义特征库树的操作按钮
    var id1 = 1, typeArr1 = [], idArr1 = [];
    //添加下一个
    $(".custom button").click(function () {
        var arr = [], cId = random(10000, 99999), i, information = false;
        for (i = 1; i < 6; i++) {
            if (selectInput[i].value === "") {
                arr.push(1);
            }
        }
        if (arr.length != 0 || selectTextarea[0].value === "" || selectTextarea[1].value === "") {
            tipWarning(tipC, tip1, tipP, "请先全部填写要处理的数据信息！");
        } else {
            $.each(applicationSecurityCustom, function (i, n) {
                if (n.name === selectInput[2].value && n.ty === selectInput[5].value) {
                    information = true;
                }
            });
            if (information) {
                tipWarning(tipC, tip1, tipP, "已存在重复数据信息！");
            } else {
                if (typeArr1.indexOf(selectInput[5].value) == -1) {
                    applicationSecurityCustom.push({
                        "id": id1,
                        "pId": 0,
                        "name": selectInput[5].value,
                        "icon": "imgs/icon04.png",
                        "isParent": true
                    });
                    typeArr1[id1] = selectInput[5].value;
                    id1++;
                }
                while (idArr1.indexOf(cId) != -1) {
                    cId = random(10000, 99999);
                }
                applicationSecurityCustom.push({
                    "id": cId,
                    "pId": typeArr1.indexOf(selectInput[5].value),
                    "name": selectInput[2].value,
                    "icon": "imgs/icon02.png",
                    "object": selectInput[1].value,
                    "operation": selectInput[3].value,
                    "l": selectInput[4].value,
                    "ty": selectInput[5].value,
                    "detection": selectTextarea[0].value,
                    "detail": selectTextarea[1].value
                });
                $.fn.zTree.init($("#treeType3"), setting, applicationSecurityCustom);
                for (i = 0; i < 6; i++) {
                    selectInput[i].value = "";
                }
                selectTextarea[0].value = "";
                selectTextarea[1].value = "";
            }
        }
    });
    //添加
    $("#application-characteristics .row:last-child .col-xs-3 .portlet-title a:nth-child(2) img").click(function () {
        for (var i = 0; i < 6; i++) {
            (i != 0) && selectInput[i].removeAttribute("disabled");
            selectInput[i].value = ""
        }
        selectTextarea[0].value = "";
        selectTextarea[0].removeAttribute("disabled");
        selectTextarea[1].value = "";
        selectTextarea[1].removeAttribute("disabled");
        $("#application-characteristics .custom button").attr("disabled", false);
    });
    //修改
    $("#application-characteristics .row:last-child .col-xs-3 .portlet-title a:nth-child(3) img").click(function () {
        var confirm = $("#application-characteristics .portlet>.f-btn-blue"), information = true;
        for (var i = 1; i < 6; i++) {
            selectInput[i].removeAttribute("disabled");
        }
        selectTextarea[0].removeAttribute("disabled");
        selectTextarea[1].removeAttribute("disabled");
        confirm.attr("disabled", false);
        confirm.click(function () {
            if (typeArr1.indexOf(selectInput[5].value) == -1 && selectInput[5].value !== "") {
                applicationSecurityCustom.push({
                    "id": id1,
                    "pId": 0,
                    "name": selectInput[5].value,
                    "icon": "imgs/icon04.png",
                    "isParent": true
                });
                typeArr1[id1] = selectInput[5].value;
                id1++;
            }
            $.each(applicationSecurityCustom, function (i, n) {
                if (n.id != selectInput[0].value && n.name === selectInput[3].value && n.ty === selectInput[5].value) {
                    tipWarning(tipC, tip1, tipP, "该类型下有重复名称的数据信息！");
                    information = false;
                }
            });
            if (information) {
                $.each(applicationSecurityCustom, function (i, n) {
                    if (n.id == selectInput[0].value) {
                        n.object = selectInput[1].value;
                        n.name = selectInput[2].value;
                        n.operation = selectInput[3].value;
                        n.l = selectInput[4].value;
                        n.ty = selectInput[5].value;
                        n.detection = selectTextarea[0].value;
                        n.detail = selectTextarea[0].value;
                        n.pId = typeArr1.indexOf(selectInput[5].value);
                    }
                });
                $.fn.zTree.init($("#treeType3"), setting, applicationSecurityCustom);
                for (var i = 0; i < 6; i++) {
                    selectInput[i].value = ""
                }
                selectTextarea[0].value = "";
                selectTextarea[0].value = "";
                $(this).attr("disabled", true);
                $("#application-characteristics .custom button").attr("disabled", false);
            }
        });
    });
    //删除
    $("#application-characteristics .row:last-child .col-xs-3 .portlet-title a:nth-child(4) img").click(function () {
        DelTree(0, 6, "#treeType3", applicationSecurityCustom, 0);
    });
</script>