<!--安全策略-入侵防护策略-例外主机-->
<div class="portlet" >
    <div class="portlet-title">
        <div class="caption caption-none">
            <ul class="bt-bars pull-left">
                <li class="active"><a href="javascript:;"><img src="imgs/8.png"/>添加</a></li>
                <li><a href="javascript:;"><img src="imgs/delete.png"/>删除</a></li>
            </ul>
            <form class="form-inline pull-left">
                <div class="form-group">
                    <label>特征ID：</label>
                    <input>
                </div>
                <div class="form-group">
                    <label>IP地址：</label>
                    <input>
                </div>
                <button type="button" class="f-btn-blue"><img src="imgs/41.png"/>查找</button>
            </form>
        </div>
    </div>
    <table class="portlet-table active portlet-body-default-none" id="exceptions">
        <thead>
        <tr>
            <td>选择</td>
            <td>特征ID</td>
            <td>攻击类别</td>
            <td>特征名称</td>
            <td data-name="name">例外IP</td>
            <td>启用</td>
            <td colspan="3">操作</td>
        </tr>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        <tr>
            <td colspan="9">
                <ul>
                </ul>
            </td>
        </tr>
        </tfoot>
    </table>
    <table class="portlet-table " id="filter3">
        <thead>
        <tr>
            <td>选择</td>
            <td>特征ID</td>
            <td>攻击类别</td>
            <td>特征名称</td>
            <td data-name="name">例外IP</td>
            <td>启用</td>
            <td colspan="3">操作</td>
        </tr>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        <tr>
            <td colspan="9">
                <ul>
                </ul>
            </td>
        </tr>
        </tfoot>
    </table>
</div>
<script>
    addData("exceptions");//加载表格内容
    position();
    var input = $("#exceptions-host form input"),//搜索输入框
            //提示框
            tipC = $(".tip-container"),
            tip = $(".tip"),
            tip1 = $(".tip1"),
            tipP = $(".tip-container p"),
            tipAll=$(".tip, .tip1"),
            child,
            tbody = $(".portlet-table tbody"),
            li = $(".bt-bars li:last-child"),
            chb;
    //表格的删除按键
    tbody.delegate("tr td:last-child img", "click", function () {
        child=$(this);
        tableDel(child,tipC,tip,tipP);
    })
        //复制按键
            .delegate("tr td:nth-last-child(2) img", "click", function () {
                var name = $(this).parent().siblings("[data-name='name']").text(), copy = {}, index = 0, j, length, arr = [];
                if ($("#application-security-policy").hasClass("active")) {
                    if ($("#WAF-strategy").hasClass("active")) {
                        length = WAFIntrusion.data.length;
                        $.each(WAFIntrusion.data, function (i, n) {
                            if (n.name === name) {
                                copy = {
                                    id: n.id + 1,
                                    feature: n.feature,
                                    agreementSafe: n.agreementSafe,
                                    contentSafe: n.contentSafe,
                                    reference: n.reference,
                                    matching: n.matching
                                };
                                index = i;
                            }
                            if (name.indexOf("副本") == -1) {
                                if (n.name.indexOf(name + "副本") != -1) {
                                    arr.push(n.name);
                                }
                            } else if (n.name.indexOf(name.slice(0, name.indexOf("副本") + 2)) != -1) {
                                arr.push(n.name);
                            }
                            arr.sort(function (a, b) {
                                return parseInt(b.slice(b.indexOf("副本") + 3)) - parseInt(a.slice(a.indexOf("副本") + 3))
                            })
                        });
                        $.each(WAFIntrusion.data, function (i, n) {
                            if (n.name === arr[0]) {
                                index = i
                            }
                        });
                        (arr.length == 0) ?
                                copy.name = name + "副本(1)"
                                : copy.name = arr[0].slice(0, arr[0].indexOf("副本") + 2) + "(" + (parseInt(arr[0].slice(arr[arr.length - 1].indexOf("副本") + 3)) + 1) + ")";
                        for (j = length - 1; j > index; j--) {
                            WAFIntrusion.data[j + 1] = WAFIntrusion.data[j];
                            WAFIntrusion.data[j + 1].id = WAFIntrusion.data[j].id + 1;
                        }
                        WAFIntrusion.data[index + 1] = copy;
                        addData("WAFIntrusion");
                    } else if ($("#exceptions-configuration").hasClass("active")) {
                        length = configuration.data.length;
                        $.each(configuration.data, function (i, n) {
                            if (n.featureID === name) {
                                copy = {
                                    id: n.id + 1,
                                    type: n.type,
                                    featureName: n.featureName,
                                    exceptionIp: n.exceptionIp,
                                    exceptionURL: n.exceptionURL
                                };
                                index = i;
                            }
                            if (name.indexOf("副本") == -1) {
                                if (n.featureID.indexOf(name + "副本") != -1) {
                                    arr.push(n.featureID);
                                }
                            } else if (n.featureID.indexOf(name.slice(0, name.indexOf("副本") + 2)) != -1) {
                                arr.push(n.featureID);
                            }
                            arr.sort(function (a, b) {
                                return parseInt(b.slice(b.indexOf("副本") + 3)) - parseInt(a.slice(a.indexOf("副本") + 3))
                            })
                        });
                        $.each(configuration.data, function (i, n) {
                            if (n.featureID === arr[0]) {
                                index = i;
                            }
                        });
                        (arr.length == 0) ?
                                copy.featureID = name + "副本(1)"
                                : copy.featureID = arr[0].slice(0, arr[0].indexOf("副本") + 2) + "(" + (parseInt(arr[0].slice(arr[arr.length - 1].indexOf("副本") + 3)) + 1) + ")";
                        for (j = length - 1; j > index; j--) {
                            configuration.data[j + 1] = configuration.data[j];
                            configuration.data[j + 1].id = configuration.data[j].id + 1;
                        }
                        configuration.data[index + 1] = copy;
                        addData("configuration");
                    }
                } else if ($("#intrusion-protection-strategy").hasClass("active")) {
                    if ($("#intrusion-protection").hasClass("active")) {
                        length = intrusion.data.length;
                        $.each(intrusion.data, function (i, n) {
                            if (n.name === name) {
                                copy = {
                                    id: n.id + 1,
                                    feature: n.feature,
                                    name: n.name,
                                    reference: n.reference,
                                    matching: n.matching
                                };
                                index = i;
                            }
                            if (name.indexOf("副本") == -1) {
                                if (n.name.indexOf(name + "副本") != -1) {
                                    arr.push(n.name);
                                }
                            } else if (n.name.indexOf(name.slice(0, name.indexOf("副本") + 2)) != -1) {
                                arr.push(n.name);
                            }
                            arr.sort(function (a, b) {
                                return parseInt(b.slice(b.indexOf("副本") + 3)) - parseInt(a.slice(a.indexOf("副本") + 3))
                            })
                        });
                        $.each(intrusion.data, function (i, n) {
                            if (n.name === arr[0]) {
                                index = i
                            }
                        });
                        (arr.length == 0) ?
                                copy.name = name + "副本(1)"
                                : copy.name = arr[0].slice(0, arr[0].indexOf("副本") + 2) + "(" + (parseInt(arr[0].slice(arr[arr.length - 1].indexOf("副本") + 3)) + 1) + ")";
                        for (j = length - 1; j > index; j--) {
                            intrusion.data[j + 1] = intrusion.data[j];
                            intrusion.data[j + 1].id = intrusion.data[j].id + 1;
                        }
                        intrusion.data[index + 1] = copy;
                        addData("intrusion");
                    } else if ($("#exceptions-host").hasClass("active")) {
                        length = exceptions.data.length;
                        $.each(exceptions.data, function (i, n) {
                            if (n.featureID === name) {
                                copy = {
                                    id: n.id + 1,
                                    type: n.type,
                                    featureName: n.featureName,
                                    exceptionId: n.exceptionId
                                };
                                index = i;
                            }
                            if (name.indexOf("副本") == -1) {
                                if (n.featureID.indexOf(name + "副本") != -1) {
                                    arr.push(n.featureID);
                                }
                            } else if (n.featureID.indexOf(name.slice(0, name.indexOf("副本") + 2)) != -1) {
                                arr.push(n.featureID);
                            }
                            arr.sort(function (a, b) {
                                return parseInt(b.slice(b.indexOf("副本") + 3)) - parseInt(a.slice(a.indexOf("副本") + 3))
                            })
                        });
                        $.each(exceptions.data, function (i, n) {
                            if (n.featureID === arr[0]) {
                                index = i;
                            }
                        });
                        (arr.length == 0) ?
                                copy.featureID = name + "副本(1)"
                                : copy.featureID = arr[0].slice(0, arr[0].indexOf("副本") + 2) + "(" + (parseInt(arr[0].slice(arr[arr.length - 1].indexOf("副本") + 3)) + 1) + ")";
                        for (j = length - 1; j > index; j--) {
                            exceptions.data[j + 1] = exceptions.data[j];
                            exceptions.data[j + 1].id = exceptions.data[j].id + 1;
                        }
                        exceptions.data[index + 1] = copy;
                        addData("exceptions");
                    }
                }
            })
        //修改按键
            .delegate("tr td:nth-last-child(3) img", "click", function () {
                var name = $(this).parent().siblings("[data-name='name']").text();
            })
        //选择框
            .delegate("tr td:first-child input", "click", function () {
                checkBox(li);
            });
    //多选删除按钮/
    li.click(function () {
        var me=$(this);
        liDel(me,tipC,tip,tipP,tip1);
    });
    //气泡提示
    $("#exceptions,#filter3").delegate("td", "mousemove", function () {
        var td = $(this).has("span");
        if (td.length != 0) {
            var content = $(this).text().replace(/ .../, ""), str = "", j,
                    name = $(this).siblings("[data-name='name']").text();
            $.each(exceptions.data, function (i, n) {
                if (n.exceptionId[0] === content && n.featureID === name) {
                    for (j = 0; j < n.exceptionId.length; j++) {
                        str += n.exceptionId[j];
                        (j != n.exceptionId.length - 1) && (str += "、");
                    }
                }
            });
            td.poshytip({
                className: "tip-yellowsimple",
                content: str.replace(/、/g, "</br>"),
                alignTo: 'target',
                alignX: 'right',
                alignY: 'center',
                offsetX: 0,
                offsetY: 5
            });
        }
    });
    //按条件搜索按钮
    $("#exceptions-host .f-btn-blue").click(function () {
        var input = $(this).siblings().children("input"), arr = [];
        if (input[0].value === "" && input[1].value === "") {
            tipWarning(tipC, tip1, tipP, "请先输入要处理的数据信息！");
        } else if (input[0].value === "" && input[1].value !== "") {
            $.each(exceptions.data, function (i, n) {
                $.each(n.exceptionId, function (j, m) {
                    if (m === input[1].value) {
                        arr.push(n);
                    }
                })
            });
        } else if (input[0].value !== "" && input[1].value !== "") {
            $.each(exceptions.data, function (i, n) {
                if (n.featureID === input[0].value) {
                    $.each(n.exceptionId, function (j, m) {
                        if (m === input[1].value) {
                            arr.push(n);
                        }
                    })
                }
            });
        } else if (input[0].value !== "" && input[1].value === "") {
            $.each(exceptions.data, function (i, n) {
                (n.featureID === input[0].value) && arr.push(n);
            });
        }
        if (arr.length == 0) {
            tipWarning(tipC, tip1, tipP, "没有所查数据信息！")
        } else {
            $.each(exceptions, function (i, n) {
                filter3.record_count = n.record_count;
                filter3.page_size = n.page_size;
                filter3.page_count = n.page_count;
                filter3.cur_page = n.cur_page;
            });
            filter3.data = arr;
            $("#exceptions").removeClass("active").siblings("table").addClass("active");
            addData("filter3");
        }
    });
</script>