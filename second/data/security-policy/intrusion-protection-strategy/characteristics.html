<div class="portlet" >
    <div class="portlet-title">
        <div class="caption">
            <form class="form-inline">
                <div class="form-group">
                    <label>查询关键字：</label>
                    <input  id="typeTreeSearch">
                </div>
                <div class="form-group">
                    <label>类型：</label>
                    <select id="selectType">
                        <option value="">请选择</option>
                        <option value="1">Buffer Overflow</option>
                        <option value="2">Dos/DDoS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>特征：</label>
                    <select class="feature" id="selectName">
                        <option value="">请选择</option>
                        <option value="1">EXPLOIT Squid Proxy Gopher Response Processing Buffer Overflow</option>
                        <option value="2">EXPLOIT Apache HTTPD mod_proxy_ajp Denial Of Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>级别：</label>
                    <select id="selectLevel">
                        <option value="">请选择</option>
                        <option value="1">轻微</option>
                        <option value="2">低</option>
                        <option value="3">中</option>
                        <option value="4">高</option>
                    </select>
                </div>
                <button type="button" class="f-btn-blue"><img src="imgs/41.png"/>查找</button>
            </form>
        </div>
    </div>
    <div class="portlet-body portlet-body-chara">
        <div class="row">
            <div class="col-xs-3">
                <div class="portlet bordered" >
                    <div class="portlet-title">基本特征库</div>
                    <div class="portlet-body">
                        <ul id="treeType" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="col-xs-9">
                <div class="portlet-body">
                    <div class="pack">
                        <div class="row">
                            <div class="col-xs-12">
                                特征名称<span></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-4">
                                特征ID<span></span>
                            </div>
                            <div class="col-xs-4">
                                危害级别<span></span>
                            </div>
                            <div class="col-xs-4">
                                攻击类型<span></span>
                            </div>
                        </div>
                        <div class="row cur">
                            <div class="col-xs-12">
                                详细描述<span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-3">
                <div class="portlet bordered" >
                    <div class="portlet-title">
                        <span>自定义特征库</span>
                        <a href="javascript:;" class="current"><img src="imgs/ad.png"/></a>
                        <a href="javascript:;"><img src="imgs/9.png"/></a>
                        <a href="javascript:;"><img src="imgs/4.png"/></a>
                        <a href="javascript:;"><img src="imgs/3.png"/></a>
                    </div>
                    <div class="portlet-body">
                        <ul id="treeType2" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="col-xs-9">
                <div class="portlet-body custom">
                    <form>
                        <div class="row">
                            <div class="form-group">
                                <label>特征名称</label>
                                <input >
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group col-xs-4">
                                <label>特征ID</label>
                                <input  disabled>
                            </div>
                            <div class="form-group col-xs-4">
                                <label>危害级别</label>
                                <input >
                            </div>
                            <div class="form-group col-xs-4">
                                <label>攻击类型</label>
                                <input >
                            </div>
                        </div>
                        <div class="form-group cur">
                            <label>详细描述</label>
                            <textarea></textarea>
                        </div>
                        <button type="button" class="btn add-btn">添加下一个</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <button type="button" class="f-btn-blue" disabled>保存</button>
</div>
<script>
    var selectSpan=$(".pack span"),//基本特征库细节显示框
        treeType=$("#treeType"),//基本特征库树
        selectButton=$("#characteristics .form-inline button"),//基本特征库搜索按钮
        key = $("#typeTreeSearch"),//基本特征库搜索框
        treeType2=$("#treeType2"),//自定义特征库树
        //自定义特征库显示框
        selectInput=$(".custom input"),
        selectTextarea=$(".custom textarea"),
        id = 1,//自定义特征库id的起始数字
        typeArr = [],//自定义类型记录数组
        idArr = [];//随机id记录数组

    $.fn.zTree.init(treeType, setting, invasionProtection);//加载基本特征库
    //绑定基本特征库的搜索框
    key.bind("focus", focusKey)
       .bind("blur", blurKey)
       .bind("propertychange", searchNode)
       .bind("input", searchNode);
    selectButton.bind("click", searchNodes);//基本特征库搜索按钮
    //基本特征库点击显示详细内容
    treeType.delegate("ul li", "click", function () {
        var li = $(this);
        $.each(invasionProtection, function (i, n) {
            (n.name === li.text() && n.ty === li.parent().siblings("a").text()) && addSpan(n, 1)
        });
    });
    //自定义特征库点击显示详细内容
    treeType2.delegate("ul li", "click", function () {
        var li = $(this), i;
        $.each(invasionProtectionCustom, function (i, n) {
            (n.name === li.text() && n.ty === li.parent().siblings("a").text()) && addSpan(n, 3)
        });
        //显示之后添加按钮和输入框都禁用
        for (i = 0; i < 4; i++) {
            (i != 1) && selectInput[i].setAttribute("disabled", "true");
            (i==0) && selectTextarea[i].setAttribute("disabled", "true");
        }
        $("#characteristics .custom button").attr("disabled", true);
    });
    //添加下一个按键
    $(".custom button").click(function () {
        var arr = [],//判断新增数据是否全部填写的数组
            cId = random(10000, 99999),//模拟随机生成id号
            information = false;//是否可以添加新数据的标识
        for (var i = 0; i < 4; i++) {
            if (i == 1) {
                continue;
            }
            (selectInput[i].value === "") && arr.push(1);
        }
        if (arr.length != 0 || selectTextarea[0].value === "") {
            tipWarning(tipC, tip1, tipP, "请先全部填写要处理的数据信息！");
        } else {
            $.each(invasionProtectionCustom, function (i, n) {
                (n.name === selectInput[0].value && n.ty === selectInput[3].value) && (information = true);
            });
            if (information) {
                tipWarning(tipC, tip1, tipP, "已存在重复数据信息！");
            } else {
                if (typeArr.indexOf(selectInput[3].value) == -1) {
                    invasionProtectionCustom.push({
                        "id": id,
                        "pId": 0,
                        "name": selectInput[3].value,
                        "icon": "imgs/icon04.png",
                        "isParent": true
                    });
                    typeArr[id] = selectInput[3].value;
                    id++;
                }
                //生成一个不重复的id号
                while (idArr.indexOf(cId) != -1) { cId = random(10000, 99999); }
                invasionProtectionCustom.push({
                    "id": cId,
                    "pId": typeArr.indexOf(selectInput[3].value),
                    "name": selectInput[0].value,
                    "icon": "imgs/icon02.png",
                    "ty": selectInput[3].value,
                    "l": selectInput[2].value,
                    "detail": selectTextarea[0].value
                });
                $.fn.zTree.init(treeType2, setting, invasionProtectionCustom);
                for (var j = 0; j < 4; j++) {
                    selectInput[j].value = "";
                    (j==0) && (selectTextarea[0].value = "");
                }
            }
        }
    });
    //自定义特征库-添加按键
    $("#characteristics .col-xs-3 .portlet-title a:nth-child(2) img").click(function () {
        for (var i = 0; i < 4; i++) {
            (i != 1) && selectInput[i].removeAttribute("disabled");
            selectInput[i].value = "";
            if(i==0){
                selectTextarea[i].removeAttribute("disabled");
                selectTextarea[i].value = "";
            }
        }
        $("#characteristics .custom button").attr("disabled", false);
    });
    //自定义特征库-修改按键
    $("#characteristics .col-xs-3 .portlet-title a:nth-child(3) img").click(function () {
        var confirm = $("#characteristics .portlet>.f-btn-blue"), information = true;
        if(selectInput[1].value!==""){
            for (var i = 0; i < 4; i++) {
                (i != 1) && selectInput[i].removeAttribute("disabled");
                (i==0) && selectTextarea[i].removeAttribute("disabled");
            }
            confirm.attr("disabled", false);
            confirm.click(function () {
                if (typeArr.indexOf(selectInput[3].value) == -1 && selectInput[3].value !== "") {
                    invasionProtectionCustom.push({
                        "id": id,
                        "pId": 0,
                        "name": selectInput[3].value,
                        "icon": "imgs/icon04.png",
                        "isParent": true
                    });
                    typeArr[id] = selectInput[3].value;
                    id++;
                }
                $.each(invasionProtectionCustom, function (i, n) {
                    if (n.id != selectInput[1].value && n.name === selectInput[0].value && n.ty === selectInput[3].value) {
                        tipWarning(tipC, tip1, tipP, "该类型下有重复名称的数据信息！");
                        information = false;
                    }
                });
                if (information) {
                    $.each(invasionProtectionCustom, function (i, n) {
                        if (n.id == selectInput[1].value) {
                            n.name = selectInput[0].value;
                            n.l = selectInput[2].value;
                            n.ty = selectInput[3].value;
                            n.detail = selectTextarea[0].value;
                            n.pId = typeArr.indexOf(selectInput[3].value);
                        }
                    });
                    $.fn.zTree.init(treeType2, setting, invasionProtectionCustom);
                    for (var i = 0; i < 4; i++) {
                        selectInput[i].value = "";
                        (i==0) && (selectTextarea[i].value = "");
                    }
                    $(this).attr("disabled", true);
                    $("#characteristics .custom button").attr("disabled", false);
                }
            });
        }
    });
    //自定义特征库-删除按键
    $("#characteristics .col-xs-3 .portlet-title a:nth-child(4) img").click(function () {
        if(selectInput[1].value!==""){
            DelTree(0, 4, "#treeType2", invasionProtectionCustom, 1);
        }
    });
    //自定义特征库-复制按键
    $("#characteristics .col-xs-3 .portlet-title a:nth-child(5) img").click(function () {
        var copy = {},
            arr = [],
            cId = random(10000, 99999);
        if (selectInput[1].value !== "") {
            $.each(invasionProtectionCustom, function (i, n) {
                if (n.id == selectInput[1].value) {
                    copy.pId = n.pId;
                    copy.icon = n.icon;
                    copy.ty = n.ty;
                    copy.l = n.l;
                    copy.detail = n.detail;
                }
                if (selectInput[0].value.indexOf("副本") == -1) {
                    (n.name.indexOf(selectInput[0].value + "副本") != -1) && arr.push(n.name);
                }else if (n.name.indexOf(selectInput[0].value.slice(0, selectInput[0].value.indexOf("副本") + 2)) != -1) {
                    arr.push(n.name);
                }
                arr.sort(function (a, b) {
                    return parseInt(b.slice(b.indexOf("副本") + 3)) - parseInt(a.slice(a.indexOf("副本") + 3))
                })
            });
            (arr.length == 0) ?
                    copy.name = selectInput[0].value + "副本(1)"
                    : copy.name = arr[0].slice(0, arr[0].indexOf("副本") + 2) + "(" + (parseInt(arr[0].slice(arr[arr.length - 1].indexOf("副本") + 3)) + 1) + ")";
            while (idArr.indexOf(cId) != -1) { cId = random(10000, 99999); }
            copy.id = cId;
            invasionProtectionCustom.push(copy);
            $.fn.zTree.init(treeType2, setting, invasionProtectionCustom);
            for (var i = 0; i < 4; i++) {
                selectInput[i].value = "";
                (i==0) && (selectTextarea[i].value = "");
            }
        }
    });
</script>